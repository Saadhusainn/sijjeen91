name: Telegram File to GitHub

on:
  repository_dispatch:
    types: [telegram-pdf]

jobs:
  process-file:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Increased timeout for large files
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Setup environment
        run: |
          # Install additional tools for better file handling
          sudo apt-get update
          sudo apt-get install -y wget pv file

      - name: Process File
        run: |
          # Configure git
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@users.noreply.github.com"
          
          # Pull latest changes to avoid conflicts
          git pull --rebase --quiet
          
          IS_ZIP="${{ github.event.client_payload.is_zip }}"
          FOLDER_NAME="${{ github.event.client_payload.folder_name }}"
          
          if [ "$IS_ZIP" = "true" ]; then
            echo "=== PROCESSING ZIP FILE ==="
            echo "ZIP URL: ${{ github.event.client_payload.pdf_url }}"
            echo "Folder name: $FOLDER_NAME"
            
            # Create folder for extraction
            mkdir -p "$FOLDER_NAME"
            
            # Download ZIP file with advanced error handling
            ZIP_FILE="temp_download.zip"
            echo "üì¶ Downloading ZIP file..."
            
            # Multiple download methods with fallback
            download_success=false
            
            # Method 1: wget with retry and progress
            if wget --tries=3 --timeout=120 --show-progress -O "$ZIP_FILE" "${{ github.event.client_payload.pdf_url }}"; then
              download_success=true
            # Method 2: curl fallback  
            elif curl -L --retry 3 --retry-delay 5 --max-time 300 --progress-bar -o "$ZIP_FILE" "${{ github.event.client_payload.pdf_url }}"; then
              download_success=true
            else
              echo "‚ùå All download methods failed"
              exit 1
            fi
            
            if [ "$download_success" = true ]; then
              echo "‚úÖ ZIP downloaded successfully"
              ZIP_SIZE=$(ls -lh "$ZIP_FILE" | cut -d ' ' -f 5)
              echo "üìä File size: $ZIP_SIZE"
              
              # Validate ZIP file
              if ! unzip -t -q "$ZIP_FILE"; then
                echo "‚ùå ZIP file is corrupted or invalid"
                exit 1
              fi
              
              # Extract ZIP file
              echo "üìÇ Extracting ZIP file..."
              if unzip -q "$ZIP_FILE" -d "$FOLDER_NAME/"; then
                FILE_COUNT=$(find "$FOLDER_NAME" -type f | wc -l)
                echo "‚úÖ Extracted $FILE_COUNT files to $FOLDER_NAME/"
                
                # Clean up ZIP file
                rm -f "$ZIP_FILE"
                
                # Add, commit and push
                git add .
                git commit -m "Add extracted files: $FOLDER_NAME ($FILE_COUNT files)"
                git pull --rebase --quiet
                if git push --quiet; then
                  echo "‚úÖ ZIP extraction completed successfully"
                else
                  echo "‚ùå Git push failed"
                  exit 1
                fi
              else
                echo "‚ùå Failed to extract ZIP file"
                exit 1
              fi
            fi
          else
            echo "=== PROCESSING PDF FILE ==="
            mkdir -p pdfs
            
            CLEAN_FILENAME="${{ github.event.client_payload.file_name }}"
            PDF_FILENAME="pdfs/${CLEAN_FILENAME}"
            
            echo "üìÑ PDF URL: ${{ github.event.client_payload.pdf_url }}"
            echo "üíæ Saving as: $PDF_FILENAME"
            
            # Download PDF with advanced error handling
            echo "‚¨áÔ∏è Downloading PDF file..."
            download_success=false
            
            # Method 1: wget with retry and progress
            if wget --tries=3 --timeout=120 --show-progress -O "$PDF_FILENAME" "${{ github.event.client_payload.pdf_url }}"; then
              download_success=true
            # Method 2: curl fallback
            elif curl -L --retry 3 --retry-delay 5 --max-time 300 --progress-bar -o "$PDF_FILENAME" "${{ github.event.client_payload.pdf_url }}"; then
              download_success=true
            else
              echo "‚ùå All download methods failed"
              exit 1
            fi
            
            if [ "$download_success" = true ]; then
              echo "‚úÖ PDF downloaded successfully"
              PDF_SIZE=$(ls -lh "$PDF_FILENAME" | cut -d ' ' -f 5)
              echo "üìä File size: $PDF_SIZE"
              
              # Enhanced file validation
              if [ ! -s "$PDF_FILENAME" ]; then
                echo "‚ùå Downloaded file is empty"
                exit 1
              fi
              
              # Check if file is a valid PDF
              if file "$PDF_FILENAME" | grep -q "PDF"; then
                echo "‚úÖ File verification passed - Valid PDF"
                
                git add .
                git commit -m "Add PDF: $CLEAN_FILENAME"
                git pull --rebase --quiet
                if git push --quiet; then
                  echo "‚úÖ PDF upload completed successfully"
                else
                  echo "‚ùå Git push failed"
                  exit 1
                fi
              else
                ACTUAL_TYPE=$(file "$PDF_FILENAME")
                echo "‚ùå Downloaded file is not a PDF. Actual type: $ACTUAL_TYPE"
                exit 1
              fi
            fi
          fi

      - name: Send completion notification
        if: success()
        run: |
          CHAT_ID="${{ github.event.client_payload.chat_id }}"
          FILENAME="${{ github.event.client_payload.file_name }}"
          REPO_NAME="${{ github.event.client_payload.repo_name }}"
          REPO_OWNER="${{ github.event.client_payload.repo_owner }}"
          IS_ZIP="${{ github.event.client_payload.is_zip }}"
          FOLDER_NAME="${{ github.event.client_payload.folder_name }}"
          
          if [ -n "$CHAT_ID" ]; then
            if [ "$IS_ZIP" = "true" ]; then
              MESSAGE="‚úÖ ZIP Extraction Complete%0A%0Aüì¶ ZIP File: $FILENAME%0AüìÅ Folder: $FOLDER_NAME%0Aüè∑Ô∏è Repository: $REPO_NAME%0A%0Aüîó View: https://github.com/$REPO_OWNER/$REPO_NAME/tree/main/$FOLDER_NAME"
            else
              MESSAGE="‚úÖ Upload Complete%0A%0AüìÑ File: $FILENAME%0Aüè∑Ô∏è Repository: $REPO_NAME%0A%0Aüîó View: https://github.com/$REPO_OWNER/$REPO_NAME/tree/main/pdfs"
            fi
            
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d "chat_id=$CHAT_ID" \
              -d "text=$MESSAGE"
            echo "üì© Notification sent successfully"
          fi

      - name: Send error notification
        if: failure()
        run: |
          CHAT_ID="${{ github.event.client_payload.chat_id }}"
          FILENAME="${{ github.event.client_payload.file_name }}"
          
          if [ -n "$CHAT_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d "chat_id=$CHAT_ID" \
              -d "text=‚ùå Upload Failed%0A%0AüìÑ File: $FILENAME%0Aüö® Error: Please try again or check the file link"
            echo "üì© Error notification sent"
          fi
