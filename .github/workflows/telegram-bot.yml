name: Telegram PDF to GitHub

on:
  repository_dispatch:
    types: [telegram-pdf]

jobs:
  process-pdf:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Set up job
        run: echo "ğŸ¯ Starting PDF upload process..."
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Setup environment
        run: |
          echo "ğŸ”§ Setting up environment..."
          sudo apt-get update
          sudo apt-get install -y wget file
          
      - name: Process File
        run: |
          echo "ğŸ“„ Starting PDF processing..."
          mkdir -p pdfs
          
          CLEAN_FILENAME="${{ github.event.client_payload.file_name }}"
          PDF_FILENAME="pdfs/${CLEAN_FILENAME}"
          
          echo "ğŸ“¥ Download URL: ${{ github.event.client_payload.pdf_url }}"
          echo "ğŸ’¾ Saving as: $PDF_FILENAME"
          
          # Download with progress reporting
          echo "â¬‡ï¸ Downloading PDF..."
          if wget --progress=dot:giga -O "$PDF_FILENAME" "${{ github.event.client_payload.pdf_url }}"; then
            echo "âœ… Download completed successfully"
            PDF_SIZE=$(ls -lh "$PDF_FILENAME" | cut -d ' ' -f 5)
            echo "ğŸ“Š File size: $PDF_SIZE"
            
            # Validate PDF
            if file "$PDF_FILENAME" | grep -q "PDF"; then
              echo "âœ… PDF validation passed"
            else
              echo "âŒ File is not a valid PDF"
              exit 1
            fi
          else
            echo "âŒ Download failed"
            exit 1
          fi
          
      - name: Commit and push
        run: |
          echo "ğŸ“¤ Committing to repository..."
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@users.noreply.github.com"
          
          git add .
          git commit -m "Add PDF: ${{ github.event.client_payload.file_name }}"
          git pull --rebase
          git push
          
          echo "âœ… Successfully uploaded PDF to repository"

      - name: Send completion notification
        run: |
          echo "ğŸ“© Sending completion notification..."
          CHAT_ID="${{ github.event.client_payload.chat_id }}"
          FILENAME="${{ github.event.client_payload.file_name }}"
          REPO_NAME="${{ github.event.client_payload.repo_name }}"
          REPO_OWNER="${{ github.event.client_payload.repo_owner }}"
          
          if [ -n "$CHAT_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d "chat_id=$CHAT_ID" \
              -d "text=âœ… PDF Upload Complete%0A%0AğŸ“„ File: $FILENAME%0AğŸ·ï¸ Repository: $REPO_NAME%0A%0AğŸ”— View: https://github.com/$REPO_OWNER/$REPO_NAME/tree/main/pdfs"
          fi
