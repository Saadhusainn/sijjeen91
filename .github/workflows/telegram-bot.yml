name: Telegram PDF to GitHub

on:
  repository_dispatch:
    types: [telegram-pdf]

jobs:
  process-pdf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Process PDF
        run: |
          # Configure git
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@users.noreply.github.com"
          
          # Pull latest changes
          git pull --rebase --quiet
          
          mkdir -p pdfs
          
          CLEAN_FILENAME="${{ github.event.client_payload.file_name }}"
          PDF_FILENAME="pdfs/${CLEAN_FILENAME}"
          QUEUE_ID="${{ github.event.client_payload.queue_id }}"
          
          echo "=== PROCESSING PDF (Queue ID: $QUEUE_ID) ==="
          echo "PDF URL: ${{ github.event.client_payload.pdf_url }}"
          echo "Saving as: $PDF_FILENAME"
          echo "Repository: ${{ github.repository }}"
          
          # Download PDF with retry and resume support
          echo "üì• Downloading PDF file..."
          
          # Use wget with retry and continue support for large files
          if wget --tries=3 --timeout=120 --continue -O "$PDF_FILENAME" "${{ github.event.client_payload.pdf_url }}"; then
            echo "‚úÖ PDF downloaded successfully"
            PDF_SIZE=$(ls -lh "$PDF_FILENAME" | cut -d ' ' -f 5)
            echo "üìä File size: $PDF_SIZE"
            
            # Verify file is not empty
            if [ -s "$PDF_FILENAME" ]; then
              echo "‚úÖ File verification passed"
              
              git add .
              git commit -m "Add PDF: $CLEAN_FILENAME"
              git pull --rebase --quiet
              git push --quiet
              
              echo "‚úÖ PDF upload completed successfully (Queue ID: $QUEUE_ID)"
            else
              echo "‚ùå Downloaded file is empty or corrupted"
              exit 1
            fi
          else
            echo "‚ùå Failed to download PDF file after 3 attempts"
            exit 1
          fi

      - name: Send completion notification
        if: success()
        run: |
          CHAT_ID="${{ github.event.client_payload.chat_id }}"
          FILENAME="${{ github.event.client_payload.file_name }}"
          REPO_NAME="${{ github.event.client_payload.repo_name }}"
          REPO_OWNER="${{ github.event.client_payload.repo_owner }}"
          QUEUE_ID="${{ github.event.client_payload.queue_id }}"
          
          if [ -n "$CHAT_ID" ]; then
            MESSAGE="‚úÖ **Upload Complete!**%0A%0AüìÑ File: $FILENAME%0AüÜî Queue ID: $QUEUE_ID%0Aüè∑Ô∏è Repository: $REPO_NAME%0Aüìä Status: Successfully uploaded%0A%0Aüîó View: https://github.com/$REPO_OWNER/$REPO_NAME/tree/main/pdfs"
            
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d "chat_id=$CHAT_ID" \
              -d "text=$MESSAGE" \
              -d "parse_mode=Markdown"
            echo "‚úÖ Completion notification sent (Queue ID: $QUEUE_ID)"
          fi
